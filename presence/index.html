<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-store" />
<title>Roblox Join</title>
<style>
  :root {
    --bg:#0f1116; --card:#151923; --fg:#e5e7eb; --muted:#9ca3af;
    --btn:#28a745; --alt:#5865f2; --warn:#f59e0b;
    --code:#111318; --border:#1f2430;
  }
  html,body { height:100%; }
  body {
    background:var(--bg);
    color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:flex; align-items:center; justify-content:center;
    margin:0;
  }
  .card {
    background:var(--card);
    padding:24px;
    border-radius:12px;
    max-width:560px;
    width:calc(100% - 24px);
    box-shadow:0 10px 24px rgba(0,0,0,.4);
  }
  .btn {
    display:inline-block;
    padding:10px 14px;
    border-radius:8px;
    text-decoration:none;
    color:#fff;
    margin-right:8px;
  }
  .primary { background:var(--btn); }
  .alt { background:var(--alt); }
  .warn { background:var(--warn); }
  .muted {
    opacity:.85;
    color:var(--muted);
    font-size:12px;
    margin-top:10px;
  }
  .row { margin:10px 0; }
  code {
    background:var(--code);
    border:1px solid var(--border);
    border-radius:6px;
    padding:3px 6px;
  }
  .copy {
    background:#2b2f3a;
    color:#e5e7eb;
    border:none;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
  }
  .copy:active { transform:translateY(1px); }
  .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
  .wrap { word-break:break-all; }
</style>
<div class="card" id="card">Loading…</div>
<script>
(function () {
  const qs = new URLSearchParams(location.search);
  const userId = qs.get('userId');
  const card = document.getElementById('card');

  if (!userId) {
    card.innerHTML =
      '<h2 style="margin:0 0 8px 0">Missing userId</h2>' +
      '<div class="muted">Pass ?userId=123456 in the URL.</div>';
    return;
  }

  const profileUrl = (u) =>
    `https://www.roblox.com/users/${u}/profile`;
  const jsonUrl = () =>
    `./${userId}.json?t=${Date.now()}`;

  function wireCopy() {
    const btn = document.getElementById('copy');
    if (!btn) return;
    btn.onclick = async () => {
      try {
        const txt = document.getElementById('cmd').innerText;
        await navigator.clipboard.writeText(txt);
        btn.innerText = 'Copied!';
        setTimeout(() => (btn.innerText = 'Copy'), 1200);
      } catch (e) {}
    };
  }

  function renderOpen(json) {
    const web = json.web || '#';
    card.innerHTML = `
      <h2 style="margin-top:0">Opening Roblox…</h2>
      <div class="row">This page will try to open the Roblox client directly.</div>
      <div class="row">
        <a class="btn primary" href="${json.join}">Open Roblox</a>
        <a class="btn alt" href="${web}">Open in Browser</a>
      </div>
      <div class="row muted">
        Server: <code>${json.placeId || '?'}</code> /
        <code>${json.jobId || '?'}</code>
      </div>
      <div class="row">
        <span class="mono wrap" id="cmd">${json.join}</span>
        <button class="copy" id="copy">Copy</button>
      </div>
      <div class="muted">
        Tip: some in-app browsers block custom protocols; use the buttons above if needed.
      </div>`;
    setTimeout(() => {
      try { location.href = json.join; } catch (e) {}
    }, 120);
    wireCopy();
  }

  function renderFollow(json) {
    const prof = profileUrl(userId);
    card.innerHTML = `
      <h2 style="margin-top:0">Follow Join</h2>
      <div class="row">Server ID is hidden; try follow join.</div>
      <div class="row">
        <a class="btn warn" href="${json.follow}">Open Roblox (Follow)</a>
        <a class="btn alt" href="${prof}">View Profile</a>
      </div>
      <div class="row">
        <span class="mono wrap" id="cmd">${json.follow}</span>
        <button class="copy" id="copy">Copy</button>
      </div>`;
    setTimeout(() => {
      try { location.href = json.follow; } catch (e) {}
    }, 120);
    wireCopy();
  }

  function renderUnavailable() {
    const prof = profileUrl(userId);
    card.innerHTML = `
      <h2 style="margin-top:0">Join link unavailable</h2>
      <div class="row">User is offline or not in a joinable server.</div>
      <div class="row">
        <a class="btn alt" href="${prof}">View Profile</a>
      </div>
      <div class="muted">Ask the bot for a fresh link.</div>`;
  }

  let tries = 0;
  async function poll() {
    tries += 1;
    try {
      const res = await fetch(jsonUrl(), { cache: 'no-store' });
      if (res.ok) {
        const json = await res.json();
        if (json && json.join) return renderOpen(json);
        if (json && json.status === 'in-game' && json.follow) return renderFollow(json);
      }
    } catch (e) {}
    if (tries < 30) {
      setTimeout(poll, 2000); // ~60s retry window
      return;
    }
    renderUnavailable();
  }

  poll();
})();
</script>
